name: Docker ì»¨í…Œì´ë„ˆë¡œ EC2ì— ë°°í¬í•˜ê¸°

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. GitHub ì €ì¥ì†Œ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout source
        uses: actions/checkout@v4

      # 2. docker-compose.yml íŒŒì¼ ìƒì„± (í•„ìš”í•œ ê²½ìš°ë§Œ)
      - name: Create docker-compose.yml
        run: |
          # docker-compose.yml íŒŒì¼ì´ ì—†ìœ¼ë©´ ìƒì„±
          if [ ! -f "docker-compose.yml" ]; then
            echo "${{ secrets.DOCKER_COMPOSE }}" > ./docker-compose.yml
          else
            echo "docker-compose.yml already exists"
          fi

      # 3. gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x ./gradlew

      # 4. í”„ë¡œì íŠ¸ ë¹Œë“œ
      - name: Gradle ë¹Œë“œ ì‹¤í–‰
        run: ./gradlew clean build

      # 5. Docker Hub ë¡œê·¸ì¸ (ì´ë¯¸ì§€ í‘¸ì‹œë¥¼ ì›í•˜ì§€ ì•Šìœ¼ë©´ ì´ ë‹¨ê³„ ìƒëµ)
      - name: Docker Hub ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 6. Docker ì´ë¯¸ì§€ ë¹Œë“œ
      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/myapp:latest .

      # 7. Docker Hubì— ì´ë¯¸ì§€ í‘¸ì‹œ (ì„ íƒì‚¬í•­)
      - name: Docker ì´ë¯¸ì§€ í‘¸ì‹œ
        run: docker push ${{ secrets.DOCKER_USERNAME }}/myapp:latest

      # 8. SSH í‚¤ ì„¤ì • ë° í…ŒìŠ¤íŠ¸
      - name: Setup and Test SSH Connection
        run: |
          # SSH í‚¤ íŒŒì¼ ìƒì„±
          echo "${{ secrets.EC2_PRIVATE_KEY }}" > /tmp/ssh_key
          chmod 600 /tmp/ssh_key
          
          # í‚¤ í˜•ì‹ í™•ì¸
          echo "ğŸ”‘ Checking SSH key format..."
          ssh-keygen -l -f /tmp/ssh_key 2>/dev/null && echo "âœ… Key format OK" || echo "âŒ Key format issue"
          
          # ì—°ê²° í…ŒìŠ¤íŠ¸
          echo "ğŸ”Œ Testing SSH connection to ${{ secrets.EC2_HOST }}..."
          ssh -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              -o BatchMode=yes \
              -i /tmp/ssh_key \
              ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} \
              "echo 'âœ… SSH connection successful'" && echo "âœ… SSH test passed" || echo "âŒ SSH test failed"

      # 9. í•„ìš”í•œ íŒŒì¼ EC2ë¡œ ì „ì†¡
      - name: Transfer files to EC2
        run: |
          echo "ğŸ“ Transferring files to EC2..."
          
          # EC2ì— ë””ë ‰í† ë¦¬ ìƒì„±
          ssh -o StrictHostKeyChecking=no \
              -i /tmp/ssh_key \
              ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} \
              "mkdir -p ~/cicd-docker && cd ~/cicd-docker && pwd"
          
          # Dockerfile ì „ì†¡ (ì¡´ì¬í•˜ëŠ” ê²½ìš°)
          if [ -f "Dockerfile" ]; then
            echo "ğŸ“„ Sending Dockerfile..."
            scp -o StrictHostKeyChecking=no \
                -i /tmp/ssh_key \
                Dockerfile \
                ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }}:~/cicd-docker/
          fi
          
          # docker-compose.yml ì „ì†¡ (ì¡´ì¬í•˜ëŠ” ê²½ìš°)
          if [ -f "docker-compose.yml" ]; then
            echo "ğŸ“„ Sending docker-compose.yml..."
            scp -o StrictHostKeyChecking=no \
                -i /tmp/ssh_key \
                docker-compose.yml \
                ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }}:~/cicd-docker/
          fi
          
          # ë¹Œë“œëœ JAR íŒŒì¼ ì „ì†¡
          echo "ğŸ“¦ Sending JAR file..."
          scp -o StrictHostKeyChecking=no \
              -i /tmp/ssh_key \
              build/libs/*.jar \
              ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }}:~/cicd-docker/

      # 10. EC2ì—ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
      - name: Deploy on EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script: |
            echo "ğŸš€ Starting deployment..."
            
            # ì‘ì—… ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd ~/cicd-docker
            
            echo "ğŸ“‚ Current directory contents:"
            ls -la
            
            echo "ğŸ³ Checking Docker..."
            docker --version
            docker ps
            
            # 1. Docker Composeë¡œ ì‹¤í–‰ (docker-compose.ymlì´ ìˆëŠ” ê²½ìš°)
            if [ -f "docker-compose.yml" ]; then
              echo "ğŸ“‹ Using docker-compose..."
              docker compose down || true
              docker compose up -d
            else
              # 2. ì§ì ‘ Dockerë¡œ ì‹¤í–‰
              echo "ğŸ”§ Running Docker directly..."
              # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
              docker stop myapp-container 2>/dev/null || true
              docker rm myapp-container 2>/dev/null || true
            
              # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
              JAR_FILE=$(ls *.jar | head -1)
              if [ -n "$JAR_FILE" ]; then
                echo "ğŸ“¦ Found JAR file: $JAR_FILE"
                docker run -d \
                  --name myapp-container \
                  -p 8080:8080 \
                  -v $(pwd):/app \
                  openjdk:11-jre-slim \
                  java -jar /app/$JAR_FILE
              else
                echo "âŒ No JAR file found!"
                exit 1
              fi
            fi
            
            echo "âœ… Deployment completed!"
            echo "ğŸ“Š Checking running containers:"
            docker ps
            echo "ğŸŒ Application should be available at: http://$(curl -s ifconfig.me):8080"